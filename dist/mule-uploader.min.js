/*! mule-uploader - v1.2.0 - 2019-09-16
* https://github.com/Flynsarmy/mule-uploader
* Copyright (c) 2019 Gabi Purcaru; Licensed MIT */

!function(i){function l(e){e.headers=e.headers||{},e.method=e.method||"GET";var t=new XMLHttpRequest;e.load_callback&&"function"==typeof e.load_callback&&t.addEventListener("load",e.load_callback,!0),e.error_callback&&"function"==typeof e.error_callback&&t.addEventListener("error",e.error_callback,!0),e.state_change_callback&&"function"==typeof e.state_change_callback&&t.addEventListener("readystatechange",e.state_change_callback),e.progress_callback&&"function"==typeof e.progress_callback&&t.upload.addEventListener("progress",e.progress_callback),e.timeout_callback&&"function"==typeof e.timeout_callback&&t.addEventListener("timeout",e.timeout_callback);var n=e.url;if(e.extra_params)for(var s in e.extra_params)e.extra_params.hasOwnProperty(s)&&(-1!==n.indexOf("?")?n+="&":n+="?",n+=encodeURIComponent(s)+"=",n+=encodeURIComponent(e.extra_params[s]));for(var i in t.open(e.method,n),e.headers)e.headers.hasOwnProperty(i)&&t.setRequestHeader(i,e.headers[i]);return e.body?t.send(e.body):t.send(),t}i.mule_upload=function(e){var t=!e.hasOwnProperty("debug")||e.debug,u=function(){};t&&console&&console.log&&(u=function(){for(var e=["[MuleUploader]"],t=0;t<arguments.length;t++)e.push(arguments[t]);return console.log.apply(console,e)});var n=1048576,r=1024*n;if(File.prototype.slice=File.prototype.webkitSlice||File.prototype.mozSlice||File.prototype.slice,!(i.File&&i.FileList&&i.Blob))return u("HTML5 APIs not available."),-1;if(-1!==navigator.userAgent.indexOf("Firefox"))try{new Blob(["something"])}catch(e){return-1}function s(e){var t=this;e=e||{},t.input=e.file_input,t.dropzone=e.dropzone?e.dropzone:null,t.file=e.file,e.autostart=!("autostart"in e)||e.autostart,e.chunk_size=e.chunk_size||6*n,e.max_size=e.max_size||5*r,e.num_workers=e.num_workers||4,e.key=e.key||"",e._key=e.key,e.key_prefix=e.key_prefix||"",e.bucket=e.bucket,e.access_key=e.access_key,e.content_type=e.content_type||"",e.content_disposition=!1!==e.content_disposition,e.acl=e.acl||"public-read",e.on_add=e.on_add||function(){},e.on_progress=e.on_progress||function(){},e.on_chunk_progress=e.on_chunk_progress||function(){},e.on_select=e.on_select||function(){},e.on_error=e.on_error||function(){},e.on_complete=e.on_complete||function(){},e.on_complete_all=e.on_complete_all||function(){},e.on_init=e.on_init||function(){},e.on_start=e.on_start||function(){},e.on_chunk_uploaded=e.on_chunk_uploaded||function(){},e.ajax_base=e.ajax_base||"/upload-backend",e.accepted_extensions=e.accepted_extensions||"",t.settings=e,t.set_state("waiting"),t.files=[],t.current_file_index=-1,t.files_uploaded=0,t.files_total_uploaded_size=0,t.input&&(t.input.onchange=function(e){return t.add_files(e.target.files),!0}),t.dropzone&&(t.dropzone.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),t.add_files(e.dataTransfer.files)}),t.dropzone.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()})),setTimeout(function(){t.settings.on_init.apply(t)},100)}return u("OK"),s.prototype.add_files=function(e){for(var t=0;t<e.length;t++)this.files.push(e[t]),this.settings.on_add.call(this,e[t]);this.files_total=this.files.length,this.files_total=this.files.length;for(t=this.files_total_size=0;t<this.files_total;t++)this.files_total_size+=this.files[t].size;return!this.settings.autostart||"waiting"==this.get_state()&&void this.upload_file()},s.prototype.start=function(){if(this.input&&this.input.files&&0<this.input.files.length)return this.upload_file(!1);alert("No file(s) selected")},s.prototype.upload_file=function(e){var t=this;if(e||t.current_file_index++,t.set_state("waiting"),t.current_file_index>=t.files.length)t.settings.on_complete_all.call(t);else{t.settings.on_progress.call(t,0,0,null),t.upload_id=null,t._progress=null,t._total_progress=null,t._loaded_chunks=null,t._uploading_chunks=null,t._chunks=null;var n=t.files[t.current_file_index];if(t.file=n,!t.file)return!1;if(""==t.settings._key?t.settings.key=t.settings.key_prefix+n.name:t.settings.key=t.settings._key,""==t.settings.content_type&&(t.settings.content_type=n.type),t.file.lastModifiedDate=t.file.lastModifiedDate||new Date(0),t.file.size>t.settings.max_size)return alert(["The maximum allowed file size is ",t.settings.max_size/r,"GB. Please select another file.","\nFile: ",n.name].join("")),t.upload_file(),!1;if(t.settings.accepted_extensions){for(var s=n.name.split(".").pop(),i=t.settings.accepted_extensions.split(","),a=!1,o=0;o<i.length;o++)if(s==i[o]){a=!0;break}if(!a)return alert(["This file format is not accepted. ","Please use a file with an extension like ",t.settings.accepted_extensions,"\nFile: ",n.name].join("")),t.upload_file(),!1}n.is_force=e,!1===t.settings.on_select.call(t,n,t.on_selected)||t.on_selected(n)}},s.prototype.on_selected=function(s){var i=this,e=_.extend_object(i.settings.extra_params||{},{filename:s.name,filesize:s.size,content_type:s.type,last_modified:s.lastModifiedDate.valueOf(),contenttype:i.settings.content_type});s.is_force&&(e.force=!0),l({url:i.settings.ajax_base+"/signing_key/",extra_params:e,headers:i.settings.headers,load_callback:function(e){var t=JSON.parse(e.target.responseText),n=/Z|\+00:?00$/.test(t.date.toString())?"":"Z";t.date=new Date(t.date+n),i.auth=t,i.auth.signing_method=i.settings.signing_method,i.upload_id=t.upload_id,i.chunks=t.chunks,i.settings.key=t.key||i.settings.key,i.settings.backup_key=i.settings.key,i.upload_id?s.is_force?i.load_file():k.list(i.auth,i.file,i.settings.key,i.upload_id,i.settings.chunk_size,function(e){for(var t=0;t<e.length;t++){var n=e[t][0]-1;i.set_progress(n,i.get_chunk_size(n)),i.set_chunk_finished(n),i.set_chunk_uploading(n,!1)}i.load_file()},function(){i.upload_id=null,this._loaded_chunks=null,i._progress=null,i._total_progress=null,i._loaded_chunks=null,i._uploading_chunks=null,i._chunks=null,i.settings.key=i.settings.backup_key,i.upload_file(!0)}):k.init(t,i.settings.key,s,i.settings,function(e){if(e.target.status/100!=2)return i.settings.on_error(e,s);var t=e.target.responseXML;i.upload_id=t.getElementsByTagName("UploadId")[0].textContent,i.load_file()})}})},s.prototype.load_file=function(){var e=this;if("waiting"==e.get_state()){e._start_fired||(e.settings.on_start.call(e,e.file),e.settings.on_progress.call(e,0,e.file.size,e.file),e._start_fired=!0),e.set_state("processing"),e.settings.on_progress.call(e,e.get_total_progress(),e.file.size,e.file);var t=e.get_next_chunk();-1!=t?e.upload_chunk(t):e.upload_finished()&&(u("All done; finish upload"),e.finish_upload());for(var n=0;n<e.settings.num_workers-1&&-1!==(t=e.get_next_chunk());n++)e.upload_chunk(t)}},s.prototype.upload_chunk=function(s){var i=this;if("processing"==i.get_state()){if(i.get_chunk_uploading(s))return u("Already Uploading"),void setTimeout(function(){-1!==i.get_next_chunk()&&i.upload_chunk(i.get_next_chunk())},1e3);if(i.set_chunk_uploading(s),u("Uploading Chunk: "+s),i.is_chunk_loaded(s)){var e=i.get_next_chunk();-1!=e?i.upload_chunk(e):i.upload_finished()&&(u("No next chunk; finish upload"),i.finish_upload())}var t=i.settings.chunk_size,n=s*t,a=Math.min(n+t,i.file.size),o=new Date;i._intervals=i._intervals||{};var r=!1,l=function(){var e=arguments,t=this;i.check_already_uploaded(function(){i.set_state("finished"),i.notify_upload_finished(),i.settings.on_progress.call(i,i.file.size,i.file.size,i.file),i.files_total_uploaded_size+=i.file.size,i.settings.on_complete.call(i,i.file),i.upload_file()},function(){if(u("Error: "),u(e),!r){r=!0,i.set_chunk_uploading(s,!1),i.set_chunk_finished(s,!1),i.set_progress(s,0),u("Abort");try{t.abort()}catch(e){u(e)}u("Retry chunk: "+s),clearInterval(i._intervals[s]),setTimeout(function(){if("processing"==i.get_state()){var e=i.get_next_chunk(s);-1!==e&&i.upload_chunk(e)}},1e3)}})};k.upload_chunk(i.auth,i.settings.key,i.upload_id,s,i.file.slice(n,a),{progress_callback:function(e){i.set_progress(s,e.loaded),i.settings.on_progress.call(i,i.get_total_progress(),i.file.size,i.file),o=new Date},state_change_callback:function(e){if(e.target.readyState==this.DONE&&"processing"==i.get_state()){if(e.target.status/100!=2)return l();u("Chunk uploaded: "+s),i.notify_chunk_uploaded(s),i.settings.on_chunk_uploaded.call(i,s),clearInterval(i._intervals[s]),i.set_progress(s,i.get_chunk_size(s)),i.set_chunk_finished(s),i.set_chunk_uploading(s,!1);var t=i.get_next_chunk();if(-1!=t)i.upload_chunk(t);else if(i.upload_finished())u("Done"),i.finish_upload();else var n=setInterval(function(){var e=i.get_next_chunk();-1!=e?(clearInterval(n),i.upload_chunk(e)):i.upload_finished()&&(clearInterval(n),i.finish_upload())},1e3)}else u(e)},error_callback:l,timeout_callback:l},function(e){i._chunk_xhr=i._chunk_xhr||[],i._chunk_xhr.push(e),i._intervals[s]=setInterval(function(){o&&15e3<new Date-o&&(u("Chunk Failed; retry"),clearInterval(i._intervals[s]),"processing"==i.get_state()&&(e.abort(),l.call(e),i._chunk_xhr[i._chunk_xhr.indexOf(e)]=null))},4e3)})}else u("NOT processing; return")},s.prototype.finish_upload=function(){var s=this;if("processing"==s.get_state()){s.set_state("finishing"),s.settings.on_progress.call(s,s.file.size,s.file.size,s.file);var i=function(e){e.target.status/100==2?(u("Finished file."),s.set_state("finished"),s.settings.on_progress.call(s,s.file.size,s.file.size,s.file),s.settings.on_complete.call(s,s.file),s.files_total_uploaded_size+=s.file.size,s.upload_file()):400==e.target.status&&-1!==e.target.responseText.indexOf("EntityTooSmall")?k.list(s.auth,s.file,s.settings.key,s.upload_id,s.settings.chunk_size,function(e){s.update_chunks(e);var t=s.get_next_chunk();s.set_state("processing"),s.upload_chunk(t)}):404==e.target.status?s.cancel(function(){s.upload_file(!0)}):s.check_already_uploaded(function(){i({target:{status:200}})},function(){i({target:{status:404}})})};k.list(s.auth,s.file,s.settings.key,s.upload_id,s.settings.chunk_size,function(e){var t=Math.ceil(s.file.size/s.settings.chunk_size);if(e.length!=t){s.update_chunks(e);var n=s.get_next_chunk();return s.set_state("processing"),void s.upload_chunk(n)}k.finish(s.auth,s.file,s.settings.key,s.upload_id,e,s.settings.chunk_size,i,i)})}},s.prototype.notify_chunk_uploaded=function(e){var t=this;if("processing"==t.get_state()){var n=t.settings.key,s=t.upload_id,i=t.settings.ajax_base+"/chunk_loaded/",a=_.extend_object(t.settings.extra_params||{},{chunk:e,key:n,upload_id:s,filename:t.file.name,filesize:t.file.size,content_type:t.file.type,last_modified:t.file.lastModifiedDate.valueOf()});l({url:i,extra_params:a,headers:t.settings.headers})}},s.prototype.check_already_uploaded=function(t,n){var e=this,s="/"+e.settings.key;n||"function"==typeof n||(n=function(){setTimeout(function(){return e.check_already_uploaded(t,n)},2500)});var i="s3"+_.region_string(e.settings.region)+".amazonaws.com",a=location.protocol+"//"+i+"/"+e.settings.bucket+"/"+s;l({url:a,method:"HEAD",load_callback:function(e){e.target.status/100==2?(u("Already Uploaded"),t()):(u("Error!"),n())},error_callback:n})},s.prototype.cancel=function(e){for(var t=this,n=0;n<t._chunk_xhr.length;n++)u("Abort chunk: "+t._chunk_xhr[n]),t._chunk_xhr[n].abort();for(var s in t._intervals=t._intervals||{},t._intervals)t._intervals.hasOwnProperty(s)&&clearInterval(t._intervals[s]);e=e||function(){},t.set_state("canceled"),t._chunk_xhr=t._chunk_xhr||[],t.settings.on_progress.call(t,0,0,null),t._chunk_xhr=null,t._chunks=null,t._uploading_chunks=null,t._loaded_chunks=null,t._start_fired=!1,t.upload_id=null,t._progress=null,t.set_state("waiting"),e()},s.prototype.update_chunks=function(e){var t,n=this,s=[],i=Math.ceil(n.file.size/n.settings.chunk_size);for(n._init_chunks(!0),n._uploading_chunks=[],n._loaded_chunks=[],t=0;t<e.length;t++){var a=parseInt(e[t][0],10);n.add_loaded_chunk(a-1),n.set_chunk_finished(a-1),s.push(a-1)}for(t=0;t<i;t++)-1===s.indexOf(t)&&(u("Chunk not uploaded: ",t),n.set_progress(t,0))},s.prototype.is_selected=function(){return!!this.file},s.prototype.get_state=function(){return this._state},s.prototype.set_state=function(e){return this._state=e},s.prototype.set_progress=function(e,t){this.log_status(),this._progress=this._progress||{},this._total_progress=(this._total_progress||0)+t-(this._progress[e]||0),this._progress[e]=t,this.settings.on_chunk_progress.call(this,e,t,this.get_chunk_size(e))},s.prototype.get_total_progress=function(){return this._total_progress||0},s.prototype.is_chunk_loaded=function(e){return this._loaded_chunks=this._loaded_chunks||[],-1!==this._loaded_chunks.indexOf(e)},s.prototype.add_loaded_chunk=function(e){this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.push(e),this.set_progress(e,this.get_chunk_size(e))},s.prototype.get_chunk_uploading=function(e){return this._uploading_chunks=this._uploading_chunks||[],-1!==this._uploading_chunks.indexOf(e)},s.prototype.set_chunk_uploading=function(e,t){if(void 0===t&&(t=!0),this._uploading_chunks=this._uploading_chunks||[],t)this._uploading_chunks.push(e);else{for(var n=[],s=0;s<this._uploading_chunks.length;s++)this._uploading_chunks[s]!=e&&n.push(this._uploading_chunks[s]);this._uploading_chunks=n}},s.prototype._init_chunks=function(e){var t=this;if(!t._chunks||e){t._chunks=[];for(var n=Math.ceil(t.file.size/t.settings.chunk_size),s=0;s<n;s++)t._chunks.push(!1)}},s.prototype.set_chunk_finished=function(e,t){void 0===t&&(t=!0);this._init_chunks(),this._chunks[e]=t},s.prototype.get_next_chunk=function(e){var t=this;if(t._init_chunks(),e&&!t._chunks[e]&&!t.get_chunk_uploading(e))return e;for(var n=0;n<t._chunks.length;n++)if(!t._chunks[n]&&!t.get_chunk_uploading(n))return n;return-1},s.prototype.upload_finished=function(){this._init_chunks();for(var e=0;e<this._chunks.length;e++)if(!this._chunks[e]||this.get_chunk_uploading(e))return!1;return!0},s.prototype.is_last_chunk=function(e){return Math.ceil(this.file.size/this.settings.chunk_size)-1==e},s.prototype.get_chunk_size=function(e){return this.is_last_chunk(e)?this.file.size%this.settings.chunk_size:this.settings.chunk_size},s.prototype.log_status=function(){},s.prototype.on_chunk_progress=function(e){this.settings.on_chunk_progress=e},s.prototype.on_add=function(e){this.settings.on_add=e},s.prototype.on_progress=function(e){this.settings.on_progress=e},s.prototype.on_select=function(e){this.settings.on_select=e},s.prototype.on_error=function(e){this.settings.on_error=e},s.prototype.on_complete=function(e){this.settings.on_complete=e},s.prototype.on_complete_all=function(e){this.settings.on_complete_all=e},s.prototype.on_init=function(e){this.settings.on_init=e},s.prototype.on_start=function(e){this.settings.on_start=e},s.prototype.on_chunk_uploaded=function(e){this.settings.on_chunk_uploaded=e},new s(e)};var k=function(e){this.settings=e};k.finish=function(e,t,n,s,i,a,o){for(var r={uploadId:s},l="<CompleteMultipartUpload>",u=0;u<i.length;u++)l+="<Part>",l+="<PartNumber>"+i[u][0]+"</PartNumber>",l+="<ETag>"+i[u][1]+"</ETag>",l+="</Part>";return l+="</CompleteMultipartUpload>",-1!==navigator.userAgent.indexOf("Firefox")&&(l=new Blob([l])),new k({auth:e,key:n,method:"POST",querystring:r,headers:{},payload:l,load_callback:o}).send()},k.list=function(_,c,h,d,g,p,f,e){var t={uploadId:d};return e&&(t["part-number-marker"]=e),new k({auth:_,key:h,method:"GET",querystring:t,headers:{},payload:"",error_callback:f,load_callback:function(e){if(404!==e.target.status){for(var t=(window.debug=e).target.responseXML,n=[],s=t.getElementsByTagName("Part"),i=Math.ceil(c.size/g),a=0;a<s.length;a++){var o=parseInt(s[a].getElementsByTagName("PartNumber")[0].textContent,10),r=s[a].getElementsByTagName("ETag")[0].textContent,l=parseInt(s[a].getElementsByTagName("Size")[0].textContent,10);o!=i&&l!=g||o==i&&l!=c.size%g||n.push([o,r,l])}if("true"===t.getElementsByTagName("IsTruncated")[0].textContent){var u=t.getElementsByTagName("NextPartNumberMarker")[0].textContent;k.list(_,c,h,d,g,function(e){p(n.concat(e))},f,u)}else p(n)}else f&&f()}}).send()},k.upload_chunk=function(e,t,n,s,i,a,o){var r,l,u,_;return a instanceof Object?(r=a.load_callback,l=a.error_callback,u=a.progress_callback,_=a.state_change_callback):r=a,new k({auth:e,key:t,method:"PUT",querystring:{partNumber:s+1,uploadId:n},headers:{},payload:i,load_callback:r,error_callback:l,progress_callback:u,state_change_callback:_}).send(o)},k.init=function(e,t,n,s,i){return new k({auth:e,key:t,method:"POST",querystring:{uploads:""},headers:{"x-amz-acl":"public-read","Content-Disposition":s.content_disposition?"attachment; filename="+n.name:"","Content-Type":e.content_type||"application/octet-stream"},payload:"",load_callback:i}).send()},k.prototype={send:function(a){var o=this;o.request_date=new Date,o.headers=o.settings.headers,o.headers.host="s3-"+o.settings.auth.region+".amazonaws.com";var e=[o.settings.auth.date.getUTCFullYear(),_.zfill(o.settings.auth.date.getUTCMonth()+1,2),_.zfill(o.settings.auth.date.getUTCDate(),2)].join("");o.settings.querystring["X-Amz-Date"]=_.uriencode(_.iso8601(o.request_date)),o.settings.querystring["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",o.settings.querystring["X-Amz-Expires"]=86400,o.settings.querystring["X-Amz-Credential"]=_.uriencode([o.settings.auth.access_key,"/"+e+"/",o.settings.auth.region+"/s3/aws4_request"].join("")),o.settings.querystring["X-Amz-SignedHeaders"]="";var t=[];for(var n in o.headers)t.push(n);t.sort(),o.settings.querystring["X-Amz-SignedHeaders"]=_.uriencode(t.join(";")),o.get_authorization_header(function(e){o.settings.querystring["X-Amz-Signature"]=e;var t=location.protocol+"//"+o.headers.host+"/"+o.settings.auth.bucket+"/"+o.settings.key;delete o.headers.host;var n=!0;for(var s in o.settings.querystring)o.settings.querystring.hasOwnProperty(s)&&(n&&(t+="?"),n=!1,t+=s+"="+o.settings.querystring[s]+"&");t=t.slice(0,-1);var i=l({url:t,method:o.settings.method,headers:o.headers,body:o.settings.payload,load_callback:o.settings.load_callback,progress_callback:o.settings.progress_callback,state_change_callback:o.settings.state_change_callback,error_callback:o.settings.error_callback,timeout_callback:o.settings.timeout_callback});a&&a(i)})},get_authorization_header:function(e){if(!this.settings.auth.date)throw"Invalid date given.";for(var t=_.get_sorted_keys(this.headers),n="",s=0;s<t.length;s++)n+=t[s].toLowerCase()+";";n=n.slice(0,-1);var i=this.get_canonical_request(),a=this.get_string_to_sign(i,this.request_date);this.settings.auth.signing_method?this.settings.auth.signing_method(a,_.iso8601(this.request_date),i,e):e(this.sign_request(a))},get_canonical_request:function(){var e="";e+=this.settings.method.toUpperCase()+"\n",e+="/"+_.uriencode(this.settings.auth.bucket+"/"+this.settings.key).replace(/%2F/g,"/")+"\n";var t,n,s,i=_.get_sorted_keys(this.settings.querystring);for(s=0;s<i.length;s++)t=i[s],n=this.settings.querystring[t],e+=_.uriencode(t)+"="+n+"&amp;";e=e.slice(0,-"&amp;".length)+"\n";var a=_.get_sorted_keys(this.headers);for(s=0;s<a.length;s++)t=a[s],n=this.headers[t],e+=t.toLowerCase()+":"+n.trim()+"\n";for(e+="\n",s=0;s<a.length;s++)e+=a[s].toLowerCase()+";";return e=e.slice(0,-1)+"\n",e+="UNSIGNED-PAYLOAD"},get_string_to_sign:function(e,t){var n="";return n+="AWS4-HMAC-SHA256\n",n+=_.iso8601(t)+"\n",n+=[t.getUTCFullYear(),_.zfill(t.getUTCMonth()+1,2),_.zfill(t.getUTCDate(),2),"/"+this.settings.auth.region+"/s3/aws4_request\n"].join(""),n+=CryptoJS.SHA256(e.replace(/&amp;/g,"&")).toString()},sign_request:function(e){if(!this.settings.auth.signature)throw"No signature provided.";return CryptoJS.HmacSHA256(e,CryptoJS.enc.Hex.parse(this.settings.auth.signature)).toString()}};var _={uriencode:function(e){var t=encodeURIComponent(e);return t=(t=(t=t.replace(/[^A-Za-z0-9_.~\-%]+/g,escape)).replace(/;/g,"%3B")).replace(/[*]/g,function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()})},get_sorted_keys:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort()},iso8601:function(e){return[e.getUTCFullYear(),_.zfill(e.getUTCMonth()+1,2),_.zfill(e.getUTCDate(),2),"T",_.zfill(e.getUTCHours(),2),_.zfill(e.getUTCMinutes(),2),_.zfill(e.getUTCSeconds(),2),"Z"].join("")},zfill:function(e,t){return("00000000000"+e).substr(-t)},region_string:function(e){return e&&"us"!==e.slice(0,2)?"-"+e:""},extend_object:function(e,t){var n=e;for(var s in t)n[s]=t[s];return n}}}(this);
//# sourceMappingURL=mule-uploader.min.js.map